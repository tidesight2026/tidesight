# AquaERP: خارطة الطريق التقنية وخطة التنفيذ اليومية

**النسخة:** 1.0  
**التاريخ:** 06 ديسمبر 2025  
**الحالة:** جاهز للتنفيذ  
**الهدف:** بناء نظام ERP سحابي (SaaS) متخصص في المزارع السمكية متوافق مع معايير ZATCA و SOCPA.

---

## الجزء الأول: المعمارية والمكدس التقني (Technical Architecture)

### 1. المكدس التقني (Tech Stack) - الزامي

* **لغة البرمجة (Backend):** Python 3.11+
* **الإطار الرئيسي (Core Framework):** Django 5.0 (لإدارة المستخدمين، الـ ORM، لوحة الإدارة، والعمليات المحاسبية).
* **إطار الـ API عالي الأداء:** Django Ninja (أسرع من DRF ويعتمد على Pydantic) أو FastAPI كخدمة منفصلة (Microservice) لمعالجة بيانات الـ IoT.
* **قاعدة البيانات:** PostgreSQL 16 (مع تفعيل PostGIS إذا لزم الأمر للخرائط).
* **الواجهة الأمامية (Frontend):** React.js (TypeScript) + Tailwind CSS (للتصميم المتجاوب).
* **إدارة المهام الخلفية (Async Tasks):** Celery + Redis (لحسابات التكاليف الليلية وإرسال الفواتير).
* **البنية التحتية (Infrastructure):** Docker & Kubernetes (لإدارة الـ Multi-tenancy).

### 2. هيكلية النظام (System Architecture)

* **نموذج المستأجرين (Multi-tenancy):** استخدام مكتبة `django-tenant-schemas` لاستخدام هيكلية **Shared Database, Isolated Schemas**. كل شركة (مزرعة) لها Schema خاصة بها في قاعدة البيانات لضمان عزل البيانات تماماً مع سهولة الصيانة.
* **التوافق المحاسبي:**
  * هيكلية `Double-Entry Bookkeeping` صارمة.
  * محرك `IAS 41 Biological Assets` لحساب إعادة تقييم المخزون الحي.
  * محرك `ZATCA Phase 2` لتوليد XML و CSR وتوقيع الفواتير.

### 3. مخطط قاعدة البيانات الأساسي (Core Schema Highlights)

* **Biological_Assets:** (ID, Batch_ID, Species, Count, Avg_Weight, Biomass, Cost_Basis, Stage).
* **Ponds/Tanks:** (ID, Type, Capacity, Location, Status).
* **Feed_Inventory:** (ID, Type, Protein_Percentage, Stock_Level, Unit_Cost).
* **Daily_Operations:** (ID, Batch_ID, Feed_Amount, Mortality_Count, Water_Quality_Logs).
* **Accounting_Ledger:** (ID, Account_Code, Debit, Credit, Transaction_Date, Reference_Type).

---

## الجزء الثاني: خطة التنفيذ التفصيلية (Day-by-Day Execution Plan)

**المدة الإجمالية للنسخة الأولى (MVP):** 12 أسبوعاً (60 يوم عمل).
**منهجية العمل:** Agile/Scrum (سبرنتات لمدة أسبوعين).

### Sprint 1: التأسيس والبنية التحتية (Foundation & Tenants)

**الهدف:** بيئة عمل جاهزة، نظام تسجيل دخول، وعزل الشركات (Tenants).

* **اليوم 1:** تهيئة بيئة التطوير (Docker Setup)، إعداد مستودع Git، إعداد Django Project Structure.
* **اليوم 2:** إعداد PostgreSQL و Redis. تثبيت `django-tenant-schemas`. تكوين الـ Public Schema (لإدارة الاشتراكات) والـ Tenant Schemas.
* **اليوم 3:** برمجة نموذج `Client` (الشركة المشتركة) ونموذج `Domain`. كتابة سكريبت لإنشاء مستأجر جديد (Tenant Provisioning) تلقائياً.
* **اليوم 4:** تصميم نظام المصادقة (Custom User Model) ليدعم مستخدمين متعددين داخل كل شركة. إعداد JWT Authentication.
* **اليوم 5:** إعداد الهيكل الأساسي للواجهة الأمامية (React + Vite + Tailwind). ربط صفحة تسجيل الدخول بالـ Backend API.

### Sprint 2: النواة البيولوجية (The Biological Engine)

**الهدف:** القدرة على إنشاء مزرعة، أحواض، وإضافة زريعة (سمك صغير).

* **اليوم 6:** تصميم نماذج `Species` (الأنواع) و `Lifecycle_Stages` (مراحل النمو).
* **اليوم 7:** برمجة وحدة `Farm_Structure` (إنشاء الأحواض/الأقفاص، تحديد الأحجام والمواقع). API للـ CRUD.
* **اليوم 8:** برمجة وحدة `Batch_Management` (إدخال دفعة جديدة، تحديد المورد، التكلفة الأولية، العدد، الوزن).
* **اليوم 9:** واجهة المستخدم لإدارة المزرعة (خريطة تفاعلية بسيطة للأحواض).
* **اليوم 10:** اختبارات (Unit Tests) للتأكد من أن البيانات البيولوجية تُحفظ بشكل صحيح في الـ Schema الخاصة بكل عميل.

### Sprint 3: العمليات اليومية (Daily Operations & FCR)

**الهدف:** تسجيل ما يحدث في المزرعة يومياً (أكل، موت، قياسات).

* **اليوم 11:** برمجة وحدة `Inventory` (مخزون الأعلاف والأدوية).
* **اليوم 12:** برمجة وحدة `Feeding_Log` (تسجيل العلف اليومي). **هام:** خوارزمية خصم العلف من المخزون وتوزيعه كتكلفة على الدفعة (WIP Cost).
* **اليوم 13:** برمجة وحدة `Mortality_Log` (تسجيل النفوق). خوارزمية تحديث العدد الحي في الحوض تلقائياً.
* **اليوم 14:** بناء الـ "Biological Calculator": دالة تحسب الـ FCR (معدل التحويل الغذائي) والكتلة الحيوية التقريبية (Estimated Biomass) بناءً على جداول النمو المعيارية.
* **اليوم 15:** واجهات React لتسجيل البيانات اليومية (Mobile-First Design) ليسهل استخدامها من قبل العمال.

### Sprint 4: المحاسبة الأساسية (Core Accounting)

**الهدف:** نظام محاسبي حقيقي (Double Entry) يعمل في الخلفية.

* **اليوم 16:** إنشاء "دليل الحسابات الموحد" (Chart of Accounts) المخصص للمزارع (يتضمن أصول بيولوجية متداولة).
* **اليوم 17:** برمجة `Journal_Entry` Model. التأكد من توازن القيد (المدين = الدائن).
* **اليوم 18:** **الربط الآلي (Automation):** كتابة Signals في Django. عند تسجيل "علف"، النظام ينشئ قيداً: (من ح/ تشغيل أحواض - إلى ح/ مخزون علف).
* **اليوم 19:** **الربط الآلي:** عند تسجيل "نفوق"، ينشئ قيداً: (من ح/ خسائر نفوق - إلى ح/ أصول بيولوجية).
* **اليوم 20:** تقارير مالية أساسية (ميزانية تجريبية Trial Balance) لكل مستأجر.

### Sprint 5: المبيعات والامتثال (Sales & ZATCA)

**الهدف:** بيع السمك وإصدار فاتورة قانونية.

* **اليوم 21:** وحدة `Harvesting` (الحصاد). تحويل "الأصل البيولوجي" إلى "مخزون منتج تام" (Finished Goods) بقيمته العادلة.
* **اليوم 22:** وحدة `Sales_Order` و `Invoices`.
* **اليوم 23:** **تكامل ZATCA (المرحلة 1):** توليد QR Code متوافق (TLV Format Base64).
* **اليوم 24:** **تكامل ZATCA (المرحلة 2):** إنشاء ملفات XML (UBL 2.1). إعداد الـ CSR وتوقيع الفاتورة إلكترونياً (ECDSA).
* **اليوم 25:** واجهة الفوترة وتصدير PDF (باستخدام مكتبة ReportLab أو WeasyPrint) يحتوي على تصميم الفاتورة الضريبية السعودية.

### Sprint 6: واجهة المستخدم والتقارير (UI Polish & Dashboards)

**الهدف:** جعل النظام جميلاً وقابلاً للاستخدام.

* **اليوم 26:** تصميم الـ Dashboard الرئيسية (Widgets: نسبة النفوق، تكلفة الكيلو الحالية، التنبيهات).
* **اليوم 27:** تحسين UX النماذج (Validations, Error Messages باللغة العربية).
* **اليوم 28:** تطبيق الترجمة (i18n) في Frontend و Backend. التأكد من محاذاة RTL كاملة.
* **اليوم 29:** تقارير الأداء (Cost per Kg Report, Batch Profitability Analysis).
* **اليوم 30:** مراجعة أمنية (Permissions, Data Leakage check).

---

## ملاحظات التنفيذ الصارمة (Strict Implementation Notes)

1. **قاعدة "لا حذف للبيانات":** أي عملية حذف هي `Soft Delete` (وضع علامة `is_active=False`). البيانات المالية لا تحذف أبداً، بل يتم عمل قيد عكسي (Reversal Entry).
2. **معيار IAS 41:** في نهاية كل شهر (Sprint لاحق)، يجب تشغيل سكريبت يعيد تقييم الأسماك بناءً على وزنها الحالي وسعر السوق، ويسجل الفرق كـ "ربح/خسارة غير محققة".
3. **الأمان:** مفاتيح التشفير الخاصة بـ ZATCA (Private Keys) تخزن في `Vault` أو `Environment Variables` مشفرة، ولا تحفظ أبداً في قاعدة البيانات مباشرة كنص واضح.
4. **الأداء:** أي عملية حسابية معقدة (مثل إعادة احتساب تكلفة الحوض التراكمية) يجب أن تتم عبر `Celery Workers` وليس في الـ Request/Response Cycle.

---
**نهاية الوثيقة.**
