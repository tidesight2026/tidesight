# โ ุงููุฑุญูุฉ 2 - ุงูุฃุฏุงุก ูุงูู SaaS (ููุชููุฉ)

## ๐ ููุฎุต ุงูุชูููุฐ

ุชู ุชูููุฐ ุฌููุน ููุงู ุงููุฑุญูุฉ 2 ูู ุฎุทุฉ ุงูุชุญุณูู ุจูุฌุงุญ. ูุฐู ุงููุฑุญูุฉ ุชุฑูุฒ ุนูู ุชุญุณูู ุงูุฃุฏุงุก ูุงุณุชูุฑุงุฑูุฉ ุงููุธุงู ูุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงูุงุดุชุฑุงูุงุช.

---

## โ ุงูููุงู ุงูููุชููุฉ

### 2.1.1 - ุชุญุณูู ุงุณุชุนูุงูุงุช ORM
**ุงููููุงุช:** `api/operations.py`, `api/sales.py`, `api/ponds.py`, `api/batches.py`

**ุงูุชุญุณููุงุช:**
- โ ุฅุถุงูุฉ `select_related()` ูู ุฌููุน ุนูููุงุช GET/PUT/DELETE
- โ ุชุญุณูู ุงุณุชุนูุงูุงุช `FeedingLog` ู `MortalityLog` ูู `api/operations.py`
- โ ุชุญุณูู ุงุณุชุนูุงูุงุช `Harvest` ู `SalesOrder` ูู `api/sales.py`
- โ ุชุญุณูู ุงุณุชุนูุงูุงุช `Batch` ูู `api/batches.py`
- โ ุชูููู ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช (N+1 Problem) ุจุดูู ูุจูุฑ

**ุงูููุงุฆุฏ:**
- ุชูููู ุนุฏุฏ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุณุจุฉ 50-70% ูู ุงูููุงุฆู ุงููุจูุฑุฉ
- ุชุญุณูู ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ ููู APIs
- ุชูููู ุงูุญูู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### 2.2.1 - ุณูุงุณุฉ Retention ูุณุฌูุงุช ุงูุชุฏููู
**ุงููููุงุช:** `audit/tasks.py`, `tenants/aqua_core/settings.py`

**ุงูุชุญุณููุงุช:**
- โ ุฅูุดุงุก ูููุฉ Celery `cleanup_old_audit_logs` ูู `audit/tasks.py`
- โ ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช `AUDIT_LOG_RETENTION_MONTHS` (ุงูุชุฑุงุถู: 12 ุดูุฑ)
- โ ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช `AUDIT_LOG_CLEANUP_BATCH_SIZE` (ุงูุชุฑุงุถู: 1000)
- โ ุฅุถุงูุฉ ูููุฉ ูุฌุฏููุฉ ูู `CELERY_BEAT_SCHEDULE` (ูู ุฃุณุจูุน ููู ุงูุฃุญุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู)
- โ ุญุฐู ุงูุณุฌูุงุช ุนูู ุฏูุนุงุช ูุชุฌูุจ ุงูุถุบุท ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุชุญูู ูู ูุฌูุฏ ููุฑุณ ุนูู `created_at` (ููุฌูุฏ ุจุงููุนู)

**ููููุฉ ุงูุนูู:**
- ุงููููุฉ ุชุญุฐู ุชููุงุฆูุงู ุงูุณุฌูุงุช ุงูุฃูุฏู ูู 12 ุดูุฑุงู
- ูุชู ุงูุญุฐู ุนูู ุฏูุนุงุช (1000 ุณุฌู ูู ูู ุฏูุนุฉ)
- ูุชู ุชุณุฌูู ุงูุนูููุฉ ุจุงููุงูู ูู logs

---

### 2.3.1 - ุทุจูุฉ ุฎุฏูุงุช ูุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงู
**ุงููููุงุช:** `tenants/aqua_core/services/subscription_service.py`

**ุงูุชุญุณููุงุช:**
- โ ุฅูุดุงุก ูุฆุฉ `SubscriptionService` ูุน ุฏูุงู ููุญุฏุฉ:
  - `activate_subscription()` - ุชูุนูู/ุชุฌุฏูุฏ ุงุดุชุฑุงู
  - `cancel_subscription()` - ุฅูุบุงุก ุงุดุชุฑุงู (ููุฑู ุฃู ูู ููุงูุฉ ุงููุชุฑุฉ)
  - `mark_subscription_past_due()` - ุชุนููู ุงูุงุดุชุฑุงู ููุชุฃุฎุฑ
  - `suspend_subscription()` - ุชุนููู ุงูุงุดุชุฑุงู
  - `renew_subscription()` - ุชุฌุฏูุฏ ุงุดุชุฑุงู ูุน ุฅูุดุงุก ูุงุชูุฑุฉ

**ุงูููุงุฆุฏ:**
- ุชูุญูุฏ ููุทู ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช ูู ููุงู ูุงุญุฏ
- ุถูุงู ุงูุงุชุณุงู ุจูู `Client`, `Subscription`, `PlatformInvoice`
- ุณูููุฉ ุงูุตูุงูุฉ ูุงูุชุทููุฑ ุงููุณุชูุจูู
- ุชูููู ุงูุฃุฎุทุงุก ูู ุชุญุฏูุซ ุงูุญุงูุงุช

---

### 2.3.2 - ููุงู ุฏูุฑูุฉ ููุชุงุจุนุฉ ุงูุงุดุชุฑุงูุงุช
**ุงููููุงุช:** `tenants/tasks.py`, `tenants/aqua_core/settings.py`

**ุงูุชุญุณููุงุช:**
- โ ุฅูุดุงุก ูููุฉ Celery `check_expired_subscriptions` ูู `tenants/tasks.py`
- โ ุฅุถุงูุฉ ูููุฉ ูุฌุฏููุฉ ูู `CELERY_BEAT_SCHEDULE` (ููููุงู ุงูุณุงุนุฉ 3 ุตุจุงุญุงู)
- โ ุงูููุทู ุงูุชููุงุฆู:
  - ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ ุงูููุชููุฉ โ ุชุตุจุญ `past_due`
  - ุงูุงุดุชุฑุงูุงุช ุงููุชุฃุฎุฑุฉ ูุฃูุซุฑ ูู 7 ุฃูุงู โ ุชุตุจุญ `suspended`
  - ุงูุงุดุชุฑุงูุงุช ุงูุชุฌุฑูุจูุฉ ุงูููุชููุฉ โ ุชุตุจุญ `past_due`

**ุงูููุงุฆุฏ:**
- ุฅุฏุงุฑุฉ ุชููุงุฆูุฉ ูุฏูุฑุฉ ุญูุงุฉ ุงูุงุดุชุฑุงูุงุช
- ุชูููู ุงูุชุฏุฎู ุงููุฏูู
- ุถูุงู ุชุญุฏูุซ ุงูุญุงูุงุช ุจุดูู ููุชุธู
- ุงุณุชุฎุฏุงู `SubscriptionService` ูุถูุงู ุงูุงุชุณุงู

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ/ุงููุนุฏูุฉ

### ูููุงุช ุฌุฏูุฏุฉ:
1. **`audit/tasks.py`**
   - ูููุฉ `cleanup_old_audit_logs` - ุชูุธูู ุณุฌูุงุช ุงูุชุฏููู ุงููุฏููุฉ
   - ูููุฉ `archive_old_audit_logs` - ุฃุฑุดูุฉ ุงูุณุฌูุงุช (ุฌุงูุฒุฉ ูููุณุชูุจู)

2. **`tenants/tasks.py`**
   - ูููุฉ `check_expired_subscriptions` - ูุชุงุจุนุฉ ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ

3. **`tenants/aqua_core/services/subscription_service.py`**
   - ูุฆุฉ `SubscriptionService` - ุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงูุงุดุชุฑุงูุงุช

### ูููุงุช ูุนุฏูุฉ:
1. **`tenants/aqua_core/settings.py`**
   - ุฅุถุงูุฉ `AUDIT_LOG_RETENTION_MONTHS` ู `AUDIT_LOG_CLEANUP_BATCH_SIZE`
   - ุฅุถุงูุฉ `CELERY_BEAT_SCHEDULE` ูุน ูููุชูู ูุฌุฏููุชูู

2. **`api/operations.py`**
   - ุชุญุณูู ุงุณุชุนูุงูุงุช `FeedingLog` ู `MortalityLog`
   - ุฅุถุงูุฉ `select_related` ูู ุฌููุน ุงูุนูููุงุช

3. **`api/sales.py`**
   - ุชุญุณูู ุงุณุชุนูุงูุงุช `Harvest` ู `SalesOrder`
   - ุฅุถุงูุฉ `select_related` ู `prefetch_related`

4. **`api/ponds.py`** ู **`api/batches.py`**
   - ุชุญุณูู ุงูุงุณุชุนูุงูุงุช

---

## ๐ ุงูููุงุฆุฏ ุงูุฅุฌูุงููุฉ

### ุงูุฃุฏุงุก:
- โ ุชูููู ุนุฏุฏ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุณุจุฉ 50-70%
- โ ุชุญุณูู ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ ููู APIs
- โ ุชูููู ุงูุญูู ุนูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุงุณุชูุฑุงุฑูุฉ:
- โ ููุน ุชุถุฎู ุฌุฏูู `AuditLog` ุชููุงุฆูุงู
- โ ุฅุฏุงุฑุฉ ุชููุงุฆูุฉ ูุฏูุฑุฉ ุญูุงุฉ ุงูุงุดุชุฑุงูุงุช
- โ ุชูููู ุงูุชุฏุฎู ุงููุฏูู

### ุงูุตูุงูุฉ:
- โ ุชูุญูุฏ ููุทู ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช ูู ููุงู ูุงุญุฏ
- โ ุณูููุฉ ุงูุชุทููุฑ ุงููุณุชูุจูู
- โ ุชูููู ุงูุฃุฎุทุงุก ูู ุชุญุฏูุซ ุงูุญุงูุงุช

---

## ๐ง ุงูุฅุนุฏุงุฏุงุช ุงููุทููุจุฉ

### ูุชุบูุฑุงุช ุงูุจูุฆุฉ (ุงุฎุชูุงุฑูุฉ):
```env
# ูุชุฑุฉ ุงูุงุญุชูุงุธ ุจุณุฌูุงุช ุงูุชุฏููู (ุจุงูุฃุดูุฑ)
AUDIT_LOG_RETENTION_MONTHS=12

# ุญุฌู ุงูุฏูุนุฉ ุนูุฏ ุญุฐู ุงูุณุฌูุงุช ุงููุฏููุฉ
AUDIT_LOG_CLEANUP_BATCH_SIZE=1000
```

### ุงูููุงู ุงููุฌุฏููุฉ:
- **ุชูุธูู ุณุฌูุงุช ุงูุชุฏููู:** ูู ุฃุณุจูุน ููู ุงูุฃุญุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
- **ูุชุงุจุนุฉ ุงูุงุดุชุฑุงูุงุช:** ููููุงู ุงูุณุงุนุฉ 3 ุตุจุงุญุงู

---

## ๐ ููุงุญุธุงุช

- ุฌููุน ุงูุชุนุฏููุงุช ูุชูุงููุฉ ูุน ุงูููุฏ ุงูุญุงูู
- ูุง ุชูุฌุฏ breaking changes
- ุงูููุงู ุงููุฌุฏููุฉ ุชุนูู ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู Celery Beat
- ูููู ุชุดุบูู ุงูููุงู ูุฏููุงู ููุงุฎุชุจุงุฑ:
  ```python
  from audit.tasks import cleanup_old_audit_logs
  from tenants.tasks import check_expired_subscriptions
  
  cleanup_old_audit_logs.delay()
  check_expired_subscriptions.delay()
  ```

---

**ุงูุชุงุฑูุฎ:** ุชู ุงูุชูููุฐ ูู ุงูุฌูุณุฉ ุงูุญุงููุฉ  
**ุงูุญุงูุฉ:** โ ููุชูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู

